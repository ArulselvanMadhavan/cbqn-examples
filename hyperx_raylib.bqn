âŸ¨âŸ¨red, green, white, blackâŸ©â‡color, raylibâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"
recâ†20
spacing â† 70
ctrlPtX â† 100
ctrlPtY â† 100
dims â† 3â€¿4
nd â† â‰ dims
nsize â† Ã—Â´dims
mat â† nsizeâ€¿nsize
dims_xy â† dims âˆ¾ 2
data â† (10âŠ¸+)âˆ˜>âˆ˜(dimsâŠ¸â¥ŠÂ¨) â†•nsize
out_t â† +Ë data

axisRots â† ((â†•â‰ dims)âŠ¸(âŒ½Ëœ))Â¨ â†•â‰ dims
revRots â† (((â†•nd)âŠ¸(âŒ½Ëœ))âˆ˜(Â¯1âŠ¸Ã—))Â¨ â†•nd

gridâ†spacing + (rec+spacing)Ã—>â¥Šâ†•dims
max_xâ€¿max_y â† âŒˆËgrid
min_xâ€¿min_y â† âŒŠËgrid
out_start â† (spacing + max_x)â€¿min_y
out_wid â† 3Ã—rec
out_spacing â† (out_widâ€¿out_wid)
out_tl â† out_startâŠ¸+Ë˜out_widÃ—>â¥Šâ†•dims
out_lines â† (âˆ¾âŸœout_spacing)Ë˜ out_tl
out_br â† (out_widâŠ¸+)â‰Â¯1 out_tl
out_rect â† out_tl â‰Ë˜ out_br
text_pos â† <âˆ˜(((Ã·âŸœ3)Â¨out_spacing)âŠ¸+)âˆ˜âŠË˜out_rect
out_txt â† text_pos âˆ¾Ë˜ (â€¢FmtÂ¨ (â¥Šout_t))
r.window.SetSize 0.5

InitMat â† {1âŒ¾(ğ•©âŠ¸âŠ‘) ğ•¨â¥Š0}

GenRot â† {ğ•¨ğ•Šğ•©:
    rots â† Â¯1â†“1+â†•â‰ ğ•©
    (ğ•¨âŠ¸(âŒ½Ëœ))Ë˜ rots
}

# Generate step table
vars â† (dimsâŠ¸InitMat)Â¨ â†•dims
GenStageRots â† {(GenRotËœâˆ˜(ğ•©âŠ¸(â‰Ëœ)))Â¨ axisRots}
# num_switches_m x stage_count_m x rots_per_stage_l x mat
rot_res â† >GenStageRotsÂ¨ â¥Švars
RevRot â† {(ğ•¨âŠ¸â‰)Ë˜ ğ•©}
hop_table â† {(revRots {ğ•¨ {RevRot}Â¨ ğ•©}Ë˜ ğ•©)}Ë˜ rot_res

Flip â† {
    HasFlag â† ((0âŠ¸<)âˆ˜+Â´âˆ˜â¥Š)
    MaybeFlip â† HasFlagâ—¶âŸ¨âŠ¢,Â¬âŸ©
    IsFlippable â† (0âŠ¸<)âˆ˜(â‰ â‰¢)
    Fn â† IsFlippableâ—¶âŸ¨âŠ¢,MaybeFlipâŸ©
    Fn ğ•©
}

pkt_flags â† {(Flipâ‰(ğ•©))Â¨ vars}Â¨ (âŒ½â†•nd)
dd â† >â‹ˆâ‰Â¯1 data
hop_reduce â† â‰hop_table

HopRdc â† {ğ•¨ğ•Šhop_id:
    hop_d â† hop_id âŠ hop_reduce
    pkt_d â† â¥Šâˆ˜>(hop_id âŠ pkt_flags)
    data â† >ğ•¨
    ldata â† (Â¯1âŠ¸âŠ)Ë˜ ğ•¨
    SwRdc â† {sw_idğ•Šğ•©:
        sw_d â† (sw_id âŠ ldata)
        pkt_f â† âŠ‘(sw_id âŠ pkt_d)
        sw_f â† âŠ‘(sw_id âŠ â¥Švars)
        StepRdc â† {
            pkt_f â† (sw_f â‰¡ pkt_f)âŠ‘(pkt_fâ€¿(pkt_fâ‰ pkt_f))
            hop_d â† âŠ‘(â¥Šğ•©) / (<Ë˜ ldata)
            pkt_d â† Ã—âŸœhop_dÂ¨ sw_fâ€¿pkt_f
            +Â´ (â‹ˆğ•¨)âˆ¾pkt_d
        }
        outstep â† (<Ë˜ sw_d) StepRdc` (â‹ˆË˜ ğ•©)
        âˆ¾Ë˜outstep
     }
     (â†•(â‰¢hop_d)) SwRdcË˜ (>hop_d)
}

out_s â† (â‹ˆ dd) HopRdc` (â‹ˆË˜ (â†•(â‰ hop_reduce)))

AddCtrlPts â†{dim_idğ•Š[x1â€¿y1â‹„x2â€¿y2]:
  ctrlOffsets â† [[(5Ã·ctrlPtX)â€¿0, (Â¯1Ã—ctrlPtX)â€¿0], [(0â€¿(5 Ã· ctrlPtY)), (0â€¿(Â¯1Ã—ctrlPtY))]]
  ctrlOffset â† dim_idâŠctrlOffsets
  plus â† 0âŠctrlOffset
  sub â† 1âŠctrlOffset
  res â† (âˆ¾âŸœ((+âŸœplus)â‰(subâŠ¸+)))Ë˜ ğ•©
  # Convert mxnxk - (mxn)xk and then convert rank 2 array to list of lists
  <â¥Šâˆ˜(â‹ˆâ‰(Â¯1))âˆ˜âˆ¾â‹ˆâ‰Â¯1 res
}

DrawBezier â† {râ€¿gâ€¿bâ€¿ağ•Špts:
    args â† ptsâˆ¾4âˆ¾2.0â‹ˆğ•¨
    raylib.DrawSplineBezierCubic args
}â‰1â€¿2

DrawRectangleLines â† {râ€¿gâ€¿bâ€¿ağ•Šxâ€¿yâ€¿wxâ€¿wy:
   raylib.DrawRectangleLinesâŸ¨x, y, wx, wy, râ€¿gâ€¿bâ€¿aâŸ©
   #raylib.DrawRectangleLines ğ•¨âˆ¾âŸœ<Ëœ(âŒˆâˆ¾âŠ¢-âŠâˆ˜ğ•©)(+ËÃ·â‰ )ğ•©
}â‰1â€¿2

GenOff â† {ğ•Šğ•©:
      midtp â† ğ•©
      lastDim â† 1â†“â†•(Â¯2âŠ¸âŠ‘â‰¢) midtp
      rotations â† {(ğ•©âŠ¸âŒ½)â‰2 midtp}Â¨ lastDim
      {midtp â‰â‰1 ğ•©}Â¨ rotations
  }

fontSize â† 20
PerFrame â† {ğ•¤
    pos â† r.mouse.GetPos@
    ellipseGrid â† {â‰âŸœ(+âŸœrec)}Ë˜ grid
    {white r.draw.EllipseOutline ğ•©}Ë˜ ellipseGrid
    #{white r.draw.Rectangle ğ•©}Ë˜ out_rect
    font â† r.font.LoadRaylib@
    {white DrawRectangleLines ğ•©}Ë˜ out_lines
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ out_txt
    midpts â† Ã·âŸœ2âˆ˜+Ëâ‰2 ellipseGrid
    midpts_xy â† dims_xy â¥Š midpts
    offsets â† (GenOffâˆ˜(midptsxyâŠ¸(â‰Ëœ)))Â¨ axisRots
    flags â† (âŒ½âˆ˜â†•nd) {(ğ•¨âŠ¸âŠ‘âˆ˜<Ëâ‰2)Â¨ğ•©}Â¨ offsets
    curves â† flags (/Ë˜)Â¨Â¨ offsets
    curvePts â† (â†•nd) {ğ•¨âŠ¸AddCtrlPtsË˜Ë˜Â¨ ğ•©}Â¨ curves
    {red DrawBezier ğ•©}Ë˜Ë˜Â¨Â¨ curvePts
} r.draw._withCanvasâŸœblack

PerFrameâ€¢_While_(Â¬r.window.ShouldClose)r.window._openAs "HyperX"
