âŸ¨âŸ¨red, green, white, blackâŸ©â‡color, raylibâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"
secs_per_step â† 3
recâ†20
spacing â† 70
ctrlPtX â† 100
ctrlPtY â† 100
dims â† 3â€¿4
nd â† â‰ dims
nsize â† Ã—Â´dims
mat â† nsizeâ€¿nsize
dims_xy â† dims âˆ¾ 2
data â† (10âŠ¸+)âˆ˜>âˆ˜(dimsâŠ¸â¥ŠÂ¨) â†•nsize
out_t â† +Ë data

axisRots â† ((â†•â‰ dims)âŠ¸(âŒ½Ëœ))Â¨ â†•â‰ dims
revRots â† (((â†•nd)âŠ¸(âŒ½Ëœ))âˆ˜(Â¯1âŠ¸Ã—))Â¨ â†•nd

gridâ†spacing + (rec+spacing)Ã—>â¥Šâ†•dims
ellipseGrid â† {â‰âŸœ(+âŸœrec)}Ë˜ grid
midpts â† (Ã·âŸœ2)+ËË˜ellipseGrid
midpts_xy â† dims_xy â¥Š midpts
max_xâ€¿max_y â† âŒˆËgrid
min_xâ€¿min_y â† âŒŠËgrid
# display expected out
out_start â† (spacing + max_x)â€¿min_y
out_wid â† 3Ã—rec
out_spacing â† (out_widâ€¿out_wid)
MkGridPts â† {ğ•©âŠ¸+Ë˜out_widÃ—>â¥Šâ†•dims}
out_tl â† MkGridPts out_start
MkGridLines â† (âˆ¾âŸœout_spacing)Ë˜
out_lines â† MkGridLines out_tl
out_br â† (out_widâŠ¸+)â‰Â¯1 out_tl
out_rect â† out_tl â‰Ë˜ out_br
MkTextPos â† <âˆ˜(((Ã·âŸœ3)Â¨out_spacing)âŠ¸+)âˆ˜âŠË˜
text_pos â† MkTextPos out_rect
FmtTxt â† {ğ•¨ âˆ¾Ë˜ (â€¢FmtÂ¨ (â¥Šğ•©))}
out_txt â† text_pos FmtTxt out_t

out_max_xâ€¿out_max_y â† âŒˆËout_br
aout_offset â† (0â€¿(out_max_y))
aout_start â† out_start + aout_offset
aout_tl â† MkGridPts aout_start
aout_lines â† MkGridLines aout_tl
aout_rect â† (aout_offsetâŠ¸+)Ë˜Ë˜ out_rect
atext_pos â† MkTextPos aout_rect

r.window.SetSize 0.25

InitMat â† {1âŒ¾(ğ•©âŠ¸âŠ‘) ğ•¨â¥Š0}

GenRot â† {ğ•¨ğ•Šğ•©:
    rots â† Â¯1â†“1+â†•â‰ ğ•©
    (ğ•¨âŠ¸(âŒ½Ëœ))Ë˜ rots
}

# Generate step table
vars â† (dimsâŠ¸InitMat)Â¨ â†•dims
GenStageRots â† {(GenRotËœâˆ˜(ğ•©âŠ¸(â‰Ëœ)))Â¨ axisRots}
# num_switches_m x stage_count_m x rots_per_stage_l x mat
rot_res â† >GenStageRotsÂ¨ â¥Švars
RevRot â† {(ğ•¨âŠ¸â‰)Ë˜ ğ•©}
hop_table â† {(revRots {ğ•¨ {RevRot}Â¨ ğ•©}Ë˜ ğ•©)}Ë˜ rot_res

Flip â† {
    HasFlag â† ((0âŠ¸<)âˆ˜+Â´âˆ˜â¥Š)
    MaybeFlip â† HasFlagâ—¶âŸ¨âŠ¢,Â¬âŸ©
    IsFlippable â† (0âŠ¸<)âˆ˜(â‰ â‰¢)
    Fn â† IsFlippableâ—¶âŸ¨âŠ¢,MaybeFlipâŸ©
    Fn ğ•©
}

hop_reduce â† â‰hop_table
reduce_flags â† {(Flipâ‰(ğ•©))Â¨ vars}Â¨ (âŒ½â†•nd)
rcomb â† hop_reduce {ğ•¨ {(â‹ˆâŸœğ•©)Ë˜ ğ•¨}Â¨ (â¥Š>ğ•©)}Ë˜ reduce_flags
hop_gather â† âŒ½hop_reduce
gather_flags â† (â†•nd) {(ğ•¨âŠ¸{Flipâ‰ğ•¨ ğ•©})Â¨ ğ•©}Ë˜ hop_gather
gcomb â† (hop_gather (â‹ˆ)Ë˜Â¨Ë˜ gather_flags)

dd â† >â‹ˆâ‰Â¯1 data

Wrapper â† {ğ•Šddâ€¿comb:
MkHop â† {ğ•¨ğ•Šhop_id:
  hop_d â† hop_id âŠ comb
  data â† >ğ•¨
  ldata â† (Â¯1âŠ¸âŠ)Ë˜ ğ•¨
  SwRdc â† {sw_idğ•Šğ•©:
    sw_d â† (sw_id âŠ ldata)
    sw_f â† âŠ‘(sw_id âŠ â¥Švars)
    Reduce â† {ğ•¨ğ•Šhop_fâ€¿pkt_f:
      pkt_f2 â† (sw_f â‰¡ pkt_f)âŠ‘(pkt_fâ€¿(pkt_fâ‰ pkt_f))
      hop_d â† âŠ‘(â¥Šhop_f) / (<Ë˜ ldata)
      pkt_d â† Ã—âŸœhop_dÂ¨ sw_fâ€¿pkt_f2
      +Â´ (â‹ˆğ•¨)âˆ¾pkt_d
    }
    Gather â† {ğ•¨ğ•Šhop_fâ€¿pkt_f:
      hop_d â† âŠ‘(â¥Šhop_f) / (<Ë˜ ldata)
      hol_f â† hop_f âˆ¨ pkt_f
      pkt_holes â† hop_dÃ—hol_f
      sw_holes â† ((Â¬hol_f)âŠ¸Ã—) ğ•¨
      +Â´ sw_holesâ€¿pkt_holes
    }
    flag2 â† âŒŠâŠ‘hop_idÃ·nd
    fn â† flag2âŠ‘Reduceâ€¿Gather
    outstep â† (<Ë˜ sw_d) fn` (â‹ˆË˜ ğ•©)
    âˆ¾Ë˜outstep
  }
 (â†•(â‰¢hop_d)) SwRdcË˜ (>hop_d)
}
out_r â† (â‹ˆ dd) MkHop` (â‹ˆË˜ (â†•(â‰ comb)))
}

rgcomb â† rcombâˆ¾gcomb
out_r â† Wrapper ddâ€¿rgcomb
out_list â† âˆ¾Ë out_r
# num_sw x total_steps x mat
out_steps â† {ğ•¨ âˆ¾Ë˜ (>ğ•©)}Â´ out_list
out_steps2 â† ((â‰Ë˜data) âˆ¾Ë˜ out_steps)
total_steps â† 1âŠ‘(â‰¢out_steps2)
duration â† (total_steps Ã— secs_per_step)
out_grouped â† (<â‰2 out_steps2)
#gg â† (â‰âˆ˜Â¯1âŠ¸âŠ)Ë˜ (âŠ‘Â¯1âŠout_r)

AddCtrlPts â†{dim_idğ•Š[x1â€¿y1â‹„x2â€¿y2]:
  ctrlOffsets â† [[(5Ã·ctrlPtX)â€¿0, (Â¯1Ã—ctrlPtX)â€¿0], [(0â€¿(5 Ã· ctrlPtY)), (0â€¿(Â¯1Ã—ctrlPtY))]]
  ctrlOffset â† dim_idâŠctrlOffsets
  plus â† 0âŠctrlOffset
  sub â† 1âŠctrlOffset
  res â† (âˆ¾âŸœ((+âŸœplus)â‰(subâŠ¸+)))Ë˜ ğ•©
  # Convert mxnxk - (mxn)xk and then convert rank 2 array to list of lists
  <â¥Šâˆ˜(â‹ˆâ‰(Â¯1))âˆ˜âˆ¾â‹ˆâ‰Â¯1 res
}

DrawBezier â† {râ€¿gâ€¿bâ€¿ağ•Špts:
    args â† ptsâˆ¾4âˆ¾2.0â‹ˆğ•¨
    raylib.DrawSplineBezierCubic args
}â‰1â€¿2

DrawRectangleLines â† {râ€¿gâ€¿bâ€¿ağ•Šxâ€¿yâ€¿wxâ€¿wy:
   raylib.DrawRectangleLinesâŸ¨x, y, wx, wy, râ€¿gâ€¿bâ€¿aâŸ©
   #raylib.DrawRectangleLines ğ•¨âˆ¾âŸœ<Ëœ(âŒˆâˆ¾âŠ¢-âŠâˆ˜ğ•©)(+ËÃ·â‰ )ğ•©
}â‰1â€¿2

GenOff â† {ğ•Šğ•©:
      midtp â† ğ•©
      lastDim â† 1â†“â†•(Â¯2âŠ¸âŠ‘â‰¢) midtp
      rotations â† {(ğ•©âŠ¸âŒ½)â‰2 midtp}Â¨ lastDim
      {midtp â‰â‰1 ğ•©}Â¨ rotations
  }

fontSize â† 20
clock â† r.StartClock@

PerFrame â† {ğ•¤
    elapsedSecs â† âŒˆclock.Time@
    secs_idx â†  duration | elapsedSecs
    step_idx â† âŒŠ(secs_idx Ã· secs_per_step)
    sw_id â† 3

    pos â† r.mouse.GetPos@
    {white r.draw.EllipseOutline ğ•©}Ë˜ ellipseGrid
    font â† r.font.LoadRaylib@
    {white DrawRectangleLines ğ•©}Ë˜ out_lines
    {white DrawRectangleLines ğ•©}Ë˜ aout_lines
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ out_txt
    aout_txt â† atext_pos FmtTxt (sw_idâ€¿step_idx âŠ‘ out_grouped)
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ aout_txt

    offsets â† (GenOffâˆ˜(midptsxyâŠ¸(â‰Ëœ)))Â¨ axisRots
    flags â† (âŒ½âˆ˜â†•nd) {(ğ•¨âŠ¸âŠ‘âˆ˜<Ëâ‰2)Â¨ğ•©}Â¨ offsets
    curves â† flags (/Ë˜)Â¨Â¨ offsets
    curvePts â† (â†•nd) {ğ•¨âŠ¸AddCtrlPtsË˜Ë˜Â¨ ğ•©}Â¨ curves
    {red DrawBezier ğ•©}Ë˜Ë˜Â¨Â¨ curvePts
} r.draw._withCanvasâŸœblack

PerFrameâ€¢_While_(Â¬r.window.ShouldClose)r.window._openAs "HyperX"
